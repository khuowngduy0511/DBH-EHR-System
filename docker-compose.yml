# =============================================================================
# DBH-EHR System - Complete Infrastructure
# =============================================================================
# Docker infrastructure with:
# - PostgreSQL: Primary + Replica (streaming replication) using Bitnami image
# - MongoDB: Replica Set (mongo1 primary, mongo2 secondary, arbiter)
# - Redis: Distributed caching
# - RabbitMQ: Message queue
# - MinIO: S3-compatible object storage
# - Hyperledger Fabric: Blockchain network (separate compose file)
# =============================================================================
# 
# USAGE:
#   1. Copy .env.example to .env and fill in your values
#   2. Run: docker-compose up -d
#   3. (Optional) Run with API: docker-compose --profile api up -d
#
# =============================================================================

services:
  # ===========================================================================
  # API Gateway (YARP) - Single entry point
  # ===========================================================================
  gateway:
    build:
      context: ./src
      dockerfile: DBH.Gateway/Dockerfile
    container_name: dbh_gateway
    environment:
      ASPNETCORE_ENVIRONMENT: Production
    ports:
      - "5000:5000"
    depends_on:
      ehr_service:
        condition: service_healthy
    networks:
      - dbh_network
    profiles:
      - api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # ASP.NET Core Auth Service (TODO: implement later)
  # ===========================================================================
  # auth_service:
  #   build:
  #     context: ./src
  #     dockerfile: DBH.Auth.Service/Dockerfile
  #   container_name: dbh_auth_service
  #   environment:
  #     ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT:-Development}
  #     CONNECTION_STRING_POSTGRESQL: "Host=pg_primary;Port=5432;Database=${POSTGRES_DB};Username=${POSTGRES_USER};Password=${POSTGRES_PASSWORD}"
  #     CONNECTION_STRING_MONGODB: "mongodb://mongo1:27017,mongo2:27017/?replicaSet=rs0"
  #   expose:
  #     - "8080"
  #   depends_on:
  #     pg_primary:
  #       condition: service_healthy
  #     mongo1:
  #       condition: service_healthy
  #   networks:
  #     - dbh_network
  #   profiles:
  #     - api
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
  #     interval: 30s
  #     timeout: 5s
  #     retries: 3
  #     start_period: 10s

  # ===========================================================================
  # ASP.NET Core EHR Service
  # ===========================================================================
  ehr_service:
    build:
      context: ./src
      dockerfile: DBH.EHR.Service/Dockerfile
    container_name: dbh_ehr_service
    environment:
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT:-Development}
      ConnectionStrings__PostgresPrimary: "Host=pg_primary;Port=5432;Database=${POSTGRES_DB};Username=${POSTGRES_USER};Password=${POSTGRES_PASSWORD}"
      ConnectionStrings__PostgresReplica: "Host=pg_replica;Port=5432;Database=${POSTGRES_DB};Username=${POSTGRES_USER};Password=${POSTGRES_PASSWORD}"
      MongoDB__ConnectionString: "mongodb://mongo1:27017,mongo2:27017/?replicaSet=rs0"
      MongoDB__DatabaseName: ${MONGO_INITDB_DATABASE:-dbh_ehr}
    ports:
      - "5050:5050"
    depends_on:
      pg_primary:
        condition: service_healthy
      pg_replica:
        condition: service_healthy
      mongo1:
        condition: service_healthy
    networks:
      - dbh_network
    profiles:
      - api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5050/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # PostgreSQL Primary (Read-Write) - Bitnami with built-in replication
  # ===========================================================================
  pg_primary:
    image: bitnami/postgresql:latest
    container_name: dbh_pg_primary
    environment:
      # Database credentials
      POSTGRESQL_USERNAME: ${POSTGRES_USER}
      POSTGRESQL_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRESQL_DATABASE: ${POSTGRES_DB}
      # Replication configuration (built-in Bitnami feature)
      POSTGRESQL_REPLICATION_MODE: master
      POSTGRESQL_REPLICATION_USER: ${POSTGRES_REPLICATION_USER}
      POSTGRESQL_REPLICATION_PASSWORD: ${POSTGRES_REPLICATION_PASSWORD}
    volumes:
      - pg_primary_data:/bitnami/postgresql
    ports:
      - "5442:5432"
    networks:
      - dbh_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # PostgreSQL Replica (Read-Only) - Auto-syncs from Primary
  # ===========================================================================
  pg_replica:
    image: bitnami/postgresql:latest
    container_name: dbh_pg_replica
    environment:
      # Replication configuration (slave mode)
      POSTGRESQL_REPLICATION_MODE: slave
      POSTGRESQL_MASTER_HOST: pg_primary
      POSTGRESQL_MASTER_PORT_NUMBER: 5432
      POSTGRESQL_REPLICATION_USER: ${POSTGRES_REPLICATION_USER}
      POSTGRESQL_REPLICATION_PASSWORD: ${POSTGRES_REPLICATION_PASSWORD}
      # Password required for health check
      POSTGRESQL_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - pg_replica_data:/bitnami/postgresql
    ports:
      - "5443:5432"
    depends_on:
      pg_primary:
        condition: service_healthy
    networks:
      - dbh_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # MongoDB Replica Set - Primary Node
  # ===========================================================================
  mongo1:
    image: mongo:7.0
    container_name: dbh_mongo1
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all", "--port", "27017"]
    environment:
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE:-dbh_ehr}
    volumes:
      - mongo1_data:/data/db
    ports:
      - "27017:27017"
    networks:
      - dbh_network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # MongoDB Replica Set - Secondary Node
  # ===========================================================================
  mongo2:
    image: mongo:7.0
    container_name: dbh_mongo2
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all", "--port", "27017"]
    volumes:
      - mongo2_data:/data/db
    ports:
      - "27018:27017"
    depends_on:
      - mongo1
    networks:
      - dbh_network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # MongoDB Replica Set - Arbiter Node
  # ===========================================================================
  mongo_arb:
    image: mongo:7.0
    container_name: dbh_mongo_arb
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all", "--port", "27017"]
    volumes:
      - mongo_arb_data:/data/db
    ports:
      - "27019:27017"
    depends_on:
      - mongo1
    networks:
      - dbh_network

  # ===========================================================================
  # MongoDB Replica Set Initializer (one-shot container)
  # ===========================================================================
  mongo_init:
    image: mongo:7.0
    container_name: dbh_mongo_init
    depends_on:
      mongo1:
        condition: service_healthy
      mongo2:
        condition: service_healthy
    networks:
      - dbh_network
    command: >
      mongosh --host mongo1:27017 --eval '
        rs.initiate({
          _id: "rs0",
          members: [
            { _id: 0, host: "mongo1:27017", priority: 2 },
            { _id: 1, host: "mongo2:27017", priority: 1 },
            { _id: 2, host: "mongo_arb:27017", arbiterOnly: true }
          ]
        });
        print("Replica set initiated successfully");
      '
    restart: "no"

  # ===========================================================================
  # Redis - Distributed Cache
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: dbh_redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - dbh_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # RabbitMQ - Message Queue
  # ===========================================================================
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: dbh_rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-dbh_123}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST:-dbh}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    networks:
      - dbh_network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_running"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ===========================================================================
  # MinIO - S3-Compatible Object Storage (Development)
  # ===========================================================================
  minio:
    image: minio/minio:latest
    container_name: dbh_minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin123}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Web Console
    networks:
      - dbh_network
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 10s
      retries: 5

  # MinIO bucket initialization
  minio_init:
    image: minio/mc:latest
    container_name: dbh_minio_init
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - dbh_network
    entrypoint: >
      /bin/sh -c "
        mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER:-minioadmin} $${MINIO_ROOT_PASSWORD:-minioadmin123};
        mc mb myminio/dbh-ehr-files --ignore-existing;
        mc anonymous set none myminio/dbh-ehr-files;
        echo 'Bucket dbh-ehr-files created successfully';
      "
    restart: "no"

# =============================================================================
# Networks
# =============================================================================
networks:
  dbh_network:
    driver: bridge
    name: dbh_ehr_network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  pg_primary_data:
    name: dbh_pg_primary_data
  pg_replica_data:
    name: dbh_pg_replica_data
  mongo1_data:
    name: dbh_mongo1_data
  mongo2_data:
    name: dbh_mongo2_data
  redis_data:
    name: dbh_redis_data
  rabbitmq_data:
    name: dbh_rabbitmq_data
  minio_data:
    name: dbh_minio_data
  mongo_arb_data:
    name: dbh_mongo_arb_data
